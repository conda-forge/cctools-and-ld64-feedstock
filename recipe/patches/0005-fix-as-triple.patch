From 91763bef16cd576858816547483d8e64ef70160d Mon Sep 17 00:00:00 2001
From: Isuru Fernando <isuruf@gmail.com>
Date: Mon, 27 Oct 2025 20:42:12 -0700
Subject: [PATCH 5/5] fix as triple

---
 cctools/as/as.c | 23 ++---------------------
 1 file changed, 2 insertions(+), 21 deletions(-)

diff --git a/cctools/as/as.c b/cctools/as/as.c
index d40f227..1a0b338 100644
--- a/cctools/as/as.c
+++ b/cctools/as/as.c
@@ -4,30 +4,13 @@
 #include <unistd.h>
 #include <stdbool.h>
 
-#ifndef __APPLE__
 static const char *get_target_triple(const char *argv0) {
     const char *env = getenv("CCTOOLS_CLANG_AS_TARGET_TRIPLE");
     if (env) {
         return env;
     }
-
-    const char *progname = strrchr(argv0, '/');
-    progname = progname ? progname + 1 : argv0;
-
-    // Example: "i386-apple-darwin-as"
-    static char triple_buf[64];
-    const char *dash = strchr(progname, '-');
-    if (dash) {
-        size_t len = dash - progname;
-        if (len < sizeof(triple_buf)) {
-            snprintf(triple_buf, sizeof(triple_buf), "%.*s-apple-darwin", (int)len, progname);
-            return triple_buf;
-        }
-    }
-
-    return "x86_64-apple-darwin";
+    return "@TRIPLE@";
 }
-#endif
 
 int main(int argc, char **argv) {
     /*
@@ -44,7 +27,7 @@ int main(int argc, char **argv) {
     bool oflag_specified = false;
 
     char *clang_exe = getenv("CCTOOLS_CLANG_AS_EXECUTABLE");
-    clang_exe = clang_exe ? clang_exe : "clang";
+    clang_exe = clang_exe ? clang_exe : "@CLANG@";
 
     char **given_args = malloc(sizeof(char*) * argc);
     char **args = malloc(sizeof(char*) * (argc + 16));
@@ -129,10 +112,8 @@ int main(int argc, char **argv) {
     /* Silence clang warnings for unused -I etc. */
     args[j++] = "-Wno-unused-command-line-argument";
 
-#ifndef __APPLE__
     args[j++] = "-target";
     args[j++] = (char*)get_target_triple(argv[0]);
-#endif
 
     args[j] = NULL;
 
